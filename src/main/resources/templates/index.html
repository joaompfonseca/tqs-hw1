<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>TQS HW1 - Environment Monitor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <!-- Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>
<body>
<div class="container">

    <div class="row m-3">
        <div class="col-12">
            <h1>TQS HW1 - Environment Monitor</h1>
        </div>
    </div>

    <form class="row m-3" method="get" action="#" th:action="@{/search}">
        <div class="col-auto">
            <label class="col-form-label" for="q">Insert a Location:</label>
        </div>
        <div class="col-auto">
            <input class="form-control" type="text" id="q" name="q" required th:value="${query}">
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" type="submit">Search</button>
        </div>

        <!-- Location and Country -->

        <div class="col-auto" th:if="${env_current != null}">
            <label class="col-form-label"
                   th:utext="${'Showing results for <b>' + env_current.location + ', ' + env_current.country} + '</b>'"></label>
        </div>
        <div class="col-auto" th:if="${env_current == null && env_forecast != null}">
            <label class="col-form-label"
                   th:utext="${'Showing results for <b>' + env_forecast.location + ', ' + env_forecast.country} + '</b>'"></label>
        </div>
    </form>

    <div class="row m-3">

        <!-- Current Environment -->

        <div class="col-6">
            <h2>Current Air Quality</h2>
        </div>

        <div class="col-12" th:if="${env_current == null}">
            <p>Nothing to show here.</p>
        </div>
        <div class="col-12" th:if="${env_current != null}">
            <table class="table">
                <thead>
                <tr>
                    <th scope="col"></th>
                    <th scope="col"></th>
                    <th scope="col">CO</th>
                    <th scope="col">NH3</th>
                    <th scope="col">NO</th>
                    <th scope="col">NO2</th>
                    <th scope="col">O3</th>
                    <th scope="col">PM10</th>
                    <th scope="col">PM2.5</th>
                    <th scope="col">SO2</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${env_current.items}">
                    <td class="text-capitalize" th:text="${#dates.format(new java.util.Date(item.dt), 'E, d')}"></td>
                    <td th:text="${#dates.format(new java.util.Date(item.dt), 'HH:mm:ss')}"></td>
                    <td th:text="${item.components.co}"></td>
                    <td th:text="${item.components.nh3}"></td>
                    <td th:text="${item.components.no}"></td>
                    <td th:text="${item.components.no2}"></td>
                    <td th:text="${item.components.o3}"></td>
                    <td th:text="${item.components.pm10}"></td>
                    <td th:text="${item.components.pm2_5}"></td>
                    <td th:text="${item.components.so2}"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Forecast Environment -->

        <div class="col-12">
            <h2>Forecast Air Quality</h2>
        </div>

        <div class="col-12" th:if="${env_forecast == null}">
            <p>Nothing to show here.</p>
        </div>
        <div class="col-12" th:if="${env_forecast != null}">
            <canvas style="width: 100%" id="env_forecast_chart"></canvas>
            <script type="text/javascript" th:inline="javascript">
                env_forecast = [[${env_forecast.items}]];
                // Get x-axis
                let xx = env_forecast.map(item => moment(new Date(item.dt)).format("dddd, D HH:mm:ss", "uk"));
                // Get y-axis
                let co = env_forecast.map(item => item.components.co);
                let nh3 = env_forecast.map(item => item.components.nh3);
                let no = env_forecast.map(item => item.components.no);
                let no2 = env_forecast.map(item => item.components.no2);
                let o3 = env_forecast.map(item => item.components.o3);
                let pm10 = env_forecast.map(item => item.components.pm10);
                let pm2_5 = env_forecast.map(item => item.components.pm2_5);
                let so2 = env_forecast.map(item => item.components.so2);
                new Chart("env_forecast_chart", {
                    type: "line",
                    data: {
                        labels: xx,
                        datasets: [
                            {data: co, fill: false, borderColor: "green", label: "CO - Carbon Monoxide"},
                            {data: nh3, fill: false, borderColor: "yellow", label: "NH3 - Ammonia"},
                            {data: no, fill: false, borderColor: "violet", label: "NO - Nitric Oxide"},
                            {data: no2, fill: false, borderColor: "orange", label: "NO2 - Nitrogen Dioxide"},
                            {data: o3, fill: false, borderColor: "red", label: "O3 - Ozone"},
                            {data: pm10, fill: false, borderColor: "cyan", label: "PM10 - Particulate Matter < 10 µm"},
                            {
                                data: pm2_5,
                                fill: false,
                                borderColor: "gray",
                                label: "PM2.5 - Particulate Matter < 2.5 µm"
                            },
                            {data: so2, fill: false, borderColor: "purple", label: "SO2 - Sulfur Dioxide"}
                        ]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: 12
                                }
                            }],
                            yAxes: [{
                                display: true,
                                title: {
                                    display: true,
                                    text: "μg/m³"
                                }
                            }]
                        },
                        tooltips: {
                            mode: "label"
                        },
                        legend: {
                            position: "bottom"
                        },
                        devicePixelRatio: 2
                    }
                });
            </script>
        </div>
    </div>
</div>
</body>
</html>